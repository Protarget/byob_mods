<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
    <id>Protarget:BannerUpload</id>
    <version>1.0</version>
    <file name="$sourcedir/Profile.php">
        <operation>
            <search position="before"><![CDATA['activateaccount' => array(
					'file' => 'Profile-Actions.php',
					'function' => 'activateAccount',
					'sc' => 'get',
					'permission' => array(
						'own' => array(),
						'any' => array('moderate_forum'),
					),
				),]]></search>
            <add><![CDATA['uploadbanner' => array(
                'label' => "Upload Banner",
                'enabled' => $context['user']['is_owner'],
                'file' => 'Profile-Actions.php',
                'function' => 'uploadBanner',
                'permission' => array(
                    'own' => array('profile_extra_any', 'profile_extra_own'),
                    'any' => array(),
                )
            ),]]>
            </add>
        </operation>
    </file>
    <file name="$sourcedir/Profile-Actions.php">
        <operation>
            <search position="end" />
            <add><![CDATA[

// Banner Upload

function uploadBanner($memId) {
    global $txt, $scripturl, $context, $settings, $modSettings, $sourcedir, $smcFunc;
    $MAX_SIZE = 4000000;
    $context['page_title'] = 'Upload a banner';
	$context['sub_template'] = 'upload_banner';
    $context['got_file'] = 'DEBUG: Uninitialized';
    if (isset($_POST['u'])) {
        $context['got_file'] = 'DEBUG: Received POST';
        if (isset($_FILES['banner_file'])) {
            $context['got_file'] = 'DEBUG: Received file';
            if ($_FILES['banner_file']['size'] <= $MAX_SIZE) {
                require_once($sourcedir . '/Subs-Graphics.php');
                $context['got_file'] = 'DEBUG: Got file and verified filesize';
                $sizes = @getimagesize($_FILES['banner_file']['tmp_name']);
                if ($sizes != false) {
                    $context['got_file'] = 'DEBUG: Got file and verified as image of dimensions ' . $sizes[0] . ', ' . $sizes[1];
                }
            }
        }
    }
    else {
        $context['got_file'] = 'DEBUG: Receiving';
    }
}

]]>
            </add>
        </operation>
    </file>
    <file name="$themedir/Profile.template.php">
        <operation>
            <search position="end" />
            <add><![CDATA[

// Banner Upload Template
function template_upload_banner() {
    global $context, $settings, $options, $scripturl, $modSettings, $txt;
    
    echo '<form action="', $scripturl, '?action=profile;area=uploadbanner;u=', $context['id_member'], ';sa=upload" method="post" accept-charset="', $context['character_set'], '" name="banner" id="banner" enctype="multipart/form-data">
    <div class="cat_bar">
        <h3 class="catbg">
            <span class="ie6_header floatleft"><img src="', $settings['images_url'], '/icons/profile_sm.gif" alt="" class="icon" />
                Upload Banner (', $context['got_file'], ')
            </span>
        </h3>
    </div>
    <div class="windowbg2">
        <span class="topslice"><span></span></span>
        <div class="content">
            <dl>
                <dt>
                    <strong>File</strong>
                    <br>
                    <span class="smalltext">
                        Must be an image file less than 4MB
                    </span>
                </dt>
                <dd>
                    <input type="file" name="banner_file" class="input_file" accept="image/*" />
                </dd>
            </dl>
            <div>
                <input id="notify_submit" type="submit" value="Upload" class="button_submit" />
                <input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
                <input type="hidden" name="u" value="', $context['id_member'], '" />
            </div>
            <br class="clear" />
        </div>
    </div>
</form>';
}

]]>
            </add>
        </operation>
    </file>
</modification>